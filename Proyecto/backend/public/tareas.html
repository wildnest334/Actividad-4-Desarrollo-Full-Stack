<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti贸n de Productos</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="container">

    <div class="header">
        <h1>Gesti贸n de Productos</h1>
        <p class="subtitle">Administra tus productos</p>
    </div>

    <div class="card">
        <h2>Productos</h2>
        <div id="mensaje"></div>
        <div id="listaProductos"></div>
    </div>

    <div class="card">
        <button id="logout">Cerrar sesi贸n</button>
    </div>

</div>

<script>
const listaProductos = document.getElementById('listaProductos');
const mensaje = document.getElementById('mensaje');
const logoutBtn = document.getElementById('logout');

let productos = [];
const token = localStorage.getItem('token');

// ==============================
// CARGAR PRODUCTOS
// ==============================
async function cargarProductos() {
    try {
        const res = await fetch('/api/productos', {
            headers: { 'Authorization': token }
        });

        if (res.status === 401) throw new Error();

        productos = await res.json();
        render();

    } catch (err) {
        alert('Sesi贸n expirada');
        localStorage.removeItem('token');
        window.location.href = '/index.html';
    }
}

// ==============================
// ELIMINAR PRODUCTO
// ==============================
async function eliminarProducto(id) {
    try {
        await fetch(`/api/productos/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': token }
        });

        productos = productos.filter(p => p._id !== id);
        render();

    } catch (err) {
        alert('Error al eliminar');
    }
}

// ==============================
// RENDER
// ==============================
function render() {
    listaProductos.innerHTML = '';

    if (productos.length === 0) {
        mensaje.innerHTML = "<p>No tienes productos registrados</p>";
        return;
    }

    mensaje.innerHTML = "";

    productos.forEach(p => {
        const item = document.createElement('div');

        item.innerHTML = `
            <hr>
            <h3>${p.nombre}</h3>
            <p>Precio: $${p.precio}</p>
            <p>Stock: ${p.stock}</p>
            <p>Caduca: ${p.fechaCaducidad ? p.fechaCaducidad.split('T')[0] : 'No definida'}</p>
            <button onclick="eliminar('${p._id}')">Eliminar</button>
        `;

        listaProductos.appendChild(item);
    });
}

function eliminar(id) {
    eliminarProducto(id);
}

// ==============================
// LOGOUT
// ==============================
logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('token');
    window.location.href = '/index.html';
});

// ==============================
// INIT
// ==============================
cargarProductos();
</script>

</body>
</html>
